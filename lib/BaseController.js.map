{"version":3,"sources":["../src/BaseController.js"],"names":["module","exports","constructor","app","baseurl","model","methods","populateOnFind","indexOf","get","Policies","checkAccessTocken","find","bind","findone","post","create","put","update","delete","destroy","req","res","Services","send","rows","total","_find","data","meta","row","_findone","_create","_update","err","oldrow","_destroy","findCreateOrderBy","orderby","query","sort","orderSort","order_sort","replace","findCreateLimit","limit","skip","undefined","findCreateWhere","where","whereData","findCreateWhereForField","tx","field","value","push","substring","Object","entries","def","attributes","forEach","index","defField","toexec","populate","exec","length","count","createEmpty","primary","_getPrimary","morePopulate","id","params","_compareData","oldData","newData","compare","keyoldval","oldval","newval","Date","isNaN","valueOf","toString","Array","isArray","JSON","stringify","isObject","o","prototype","call","log","modellogevents","newrow","_checkPopulateSended","body","_log","modelToJoin","global","primaryToJoin","cb","updateDeleteField","d","modelEvent","c","Logs","us_id_user","user","us_id","lg_model_event","lg_model_name","modelname","lg_model_id","lg_data","before","policy","render","page"],"mappings":"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","sourcesContent":["\"use strict\";\n\n// warning : reactiver\nmodule.exports = class {\n\tconstructor(app, baseurl, model, methods = [\"find\", \"findone\", \"create\", \"update\", \"destroy\"]) {\n\t\t//[\"find\", \"findone\", \"create\", \"update\", \"destroy\"]\n\t\tif (!methods) methods = [];\n\t\tthis.app = app;\n\t\tthis.baseurl = baseurl;\n\t\tthis.model = model;\n\t\tthis.populateOnFind = true;\n\t\tif (methods.indexOf(\"find\") >= 0) app.get(this.baseurl + \"\", Policies.checkAccessTocken, this.find.bind(this));\n\t\tif (methods.indexOf(\"findone\") >= 0) app.get(this.baseurl + \"/:id\", Policies.checkAccessTocken, this.findone.bind(this));\n\t\tif (methods.indexOf(\"create\") >= 0) app.post(this.baseurl + \"\", Policies.checkAccessTocken, this.create.bind(this));\n\t\tif (methods.indexOf(\"update\") >= 0) app.put(this.baseurl + \"/:id\", Policies.checkAccessTocken, this.update.bind(this));\n\t\tif (methods.indexOf(\"destroy\") >= 0) app.delete(this.baseurl + \"/:id\", Policies.checkAccessTocken, this.destroy.bind(this));\n\t}\n\t// send(res,errorKeyOrData) {\n\t// \tlet status = 200,\n\t// \t\tdata = { err: null, data: null };\n\t// \terrorKeyOrData = errorKeyOrData || {};\n\t// \tif (_.isString(errorKeyOrData)) {\n\t// \t\tdata.err = this.getErrorCode(errorKeyOrData);\n\t// \t\tstatus = data.err.status;\n\t// \t} else {\n\t// \t\tdata = errorKeyOrData;\n\t// \t\tdata.err = null;\n\t// \t}\n\t// \t// console.log(\"err :\", err);\n\t// \tres.status(status).send(data);\n\t// }\n\tasync find(req, res) {\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\tif (!this.model) return Services.send(res, \"model_not_defined\");\n\t\tlet { rows, total } = await this._find(req);\n\t\tServices.send(res, { data: rows, meta: { total: total } });\n\t}\n\tasync findone(req, res) {\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\tif (!this.model) return Services.send(res, \"model_not_defined\");\n\t\tlet row = await this._findone(req);\n\t\tif (!row) return Services.send(res, \"not_found\");\n\t\tServices.send(res, { data: row });\n\t}\n\tasync create(req, res) {\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\tif (!this.model) return Services.send(res, \"model_not_defined\");\n\t\tlet row = await this._create(req);\n\t\tServices.send(res, { data: row });\n\t}\n\tasync update(req, res) {\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\tif (!this.model) return Services.send(res, \"model_not_defined\");\n\t\tlet row = await this._update(req);\n\t\tif (!row) return Services.send(res, \"not_found\");\n\t\tServices.send(res, { data: row });\n\t}\n\tasync destroy(req, res) {\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\tif (!this.model) return this.send(res, { err: Services.err(501), data: null });\n\t\tlet oldrow = await this._destroy(req);\n\t\tServices.send(res, { data: oldrow });\n\t}\n\n\tasync findCreateOrderBy(req) {\n\t\tlet orderby = \"\";\n\t\t// @Marina je corrige ici, car il faut rajouter le orderSort, uniquement s'il y a un req.query.sort\n\t\tif (req.query.sort) {\n\t\t\tlet orderSort = \"\";\n\t\t\tif (req.query.order_sort) orderSort = req.query.order_sort.replace(/\\\\/g, \"\");\n\t\t\torderby = \" order by \" + req.query.sort.replace(/\\\\/g, \"\") + \" \" + orderSort;\n\t\t}\n\t\treturn orderby;\n\t}\n\tasync findCreateLimit(req) {\n\t\tlet limit = \"\",\n\t\t\tskip = 0;\n\t\tif (req.query.skip != undefined && req.query.skip != \"NaN\" && typeof (req.query.skip * 1) === \"number\") {\n\t\t\tskip = req.query.skip * 1;\n\t\t}\n\t\tif (req.query.limit != undefined && typeof (req.query.limit * 1) === \"number\") {\n\t\t\t// if (!req.query.skip || !_.isNumber(req.query.skip * 1)) req.query.skip = 0;\n\t\t\tlimit = \" limit \" + skip + \",\" + req.query.limit * 1;\n\t\t}\n\t\treturn limit;\n\t}\n\tasync findCreateWhere(req) {\n\t\tlet where = \"1=1\",\n\t\t\twhereData = [];\n\t\tlet model = this.model;\n\t\tfunction findCreateWhereForField(tx, field, value) {\n\t\t\t// console.log(\"field\", field);\n\t\t\tif (value.indexOf(\"contains:\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" like ?\";\n\t\t\t\twhereData.push(\"%\" + value.substring(9) + \"%\");\n\t\t\t} else if (value.indexOf(\"startwith:\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" like ?\";\n\t\t\t\twhereData.push(value.substring(10) + \"%\");\n\t\t\t} else if (value.indexOf(\"endwith:\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" like ?\";\n\t\t\t\twhereData.push(\"%\" + value.substring(8));\n\t\t\t} else if (value.indexOf(\">=\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" >= ?\";\n\t\t\t\twhereData.push(value.substring(2));\n\t\t\t} else if (value.indexOf(\">\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" > ?\";\n\t\t\t\twhereData.push(value.substring(1));\n\t\t\t} else if (value.indexOf(\"<=\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" <= ?\";\n\t\t\t\twhereData.push(value.substring(2));\n\t\t\t} else if (value.indexOf(\"<\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" < ?\";\n\t\t\t\twhereData.push(value.substring(1));\n\t\t\t} else {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \"=?\";\n\t\t\t\twhereData.push(req.query[field]);\n\t\t\t}\n\t\t}\n\n\t\tObject.entries(model.def.attributes).forEach(([field, defField], index) => {\n\t\t\t// console.log(\"field\", field, req.query[field]);\n\t\t\t// if (defField.model) {\n\t\t\t// \tlet modelJoin = global[defField.model];\n\t\t\t// \t_.each(modelJoin.def.attributes, (defFieldJoin, fieldJoin) => {\n\t\t\t// \t\tif (req.query[fieldJoin]) findCreateWhereForField(\"t1\",fieldJoin, req.query[fieldJoin]);\n\t\t\t// \t\tif (req.query[fieldJoin + \"__\"]) findCreateWhereForField(\"t1\",fieldJoin, req.query[fieldJoin + \"__\"]);\n\t\t\t// \t});\n\t\t\t// } else {\n\t\t\tif (req.query[field]) findCreateWhereForField(\"t1\", field, req.query[field] + \"\");\n\t\t\tif (req.query[field + \"_\"]) findCreateWhereForField(\"t1\", field, req.query[field + \"_\"]);\n\t\t\tif (req.query[field + \"__\"]) findCreateWhereForField(\"t1\", field, req.query[field + \"__\"]);\n\t\t\tif (req.query[field + \"___\"]) findCreateWhereForField(\"t1\", field, req.query[field + \"___\"]);\n\t\t\t// }\n\t\t});\n\t\t// console.log(\"where,whereData\", where, whereData);\n\t\treturn { where, whereData };\n\t}\n\n\tasync _find(req) {\n\t\tlet model = this.model;\n\n\t\tlet { where, whereData } = await this.findCreateWhere(req);\n\t\t// console.log(\"where,whereData\", where, whereData);\n\t\tlet limit = await this.findCreateLimit(req);\n\t\tlet orderby = await this.findCreateOrderBy(req);\n\t\tlet toexec = model.find(where + orderby + limit, whereData);\n\t\t// console.log(\"where + orderby + limit, whereData\", where + orderby + limit, whereData);\n\t\t// if (this.populateOnFind) {\n\t\tif (this.populateOnFind) {\n\t\t\tObject.entries(model.def.attributes).forEach(([field, defField], index) => {\n\t\t\t\tif (defField.model) toexec.populate(field);\n\t\t\t});\n\t\t}\n\t\t// }\n\t\t// let t0;\n\t\t// t0 = moment();\n\t\tlet rows = await toexec.exec();\n\t\t// console.log(\"rows\", rows);\n\t\t// console.log(\"diff1\", t0.diff(moment()));\n\t\t// t0 = moment();\n\t\tlet total = rows.length;\n\t\tif (limit) {\n\t\t\t// console.log(\"where,whereData\", where, whereData);\n\t\t\tlet toexec = model.count(where + orderby, whereData);\n\t\t\tif (this.populateOnFind) {\n\t\t\t\tObject.entries(model.def.attributes).forEach(([field, defField], index) => {\n\t\t\t\t\tif (defField.model) toexec.populate(field);\n\t\t\t\t});\n\t\t\t}\n\t\t\ttotal = await toexec.exec();\n\t\t\t// console.log(\"rows_temp\", rows_temp);\n\t\t\t// total = rows_temp.length;\n\t\t}\n\t\t// console.log(\"diff2\", t0.diff(moment()));\n\t\treturn { rows, total };\n\t}\n\n\tasync createEmpty(req) {\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet model = this.model;\n\t\tlet primary = this._getPrimary(model);\n\t\tlet row = model.createEmpty();\n\t\trow[primary] = \"\";\n\t\treturn row;\n\t}\n\t_getPrimary(model) {\n\t\tlet primary = null;\n\t\tObject.entries(model.def.attributes).forEach(([field, defField], index) => {\n\t\t\tif (defField.primary) primary = field;\n\t\t});\n\t\treturn primary;\n\t}\n\n\tasync _findone(req, morePopulate = []) {\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet model = this.model;\n\t\tlet where = \"\",\n\t\t\twhereData = [],\n\t\t\tprimary = this._getPrimary(model),\n\t\t\trow,\n\t\t\tid = req.params.id || req.params[primary];\n\n\t\tif (id * 1 < 0) {\n\t\t\t// console.log(\"createempty\");\n\t\t\trow = await this.createEmpty(req);\n\t\t} else {\n\t\t\twhere += \"t1.\" + primary + \"=?\";\n\t\t\twhereData.push(id);\n\t\t\tlet toexec = model.findone(where, whereData);\n\t\t\tObject.entries(model.def.attributes).forEach(([field, defField], index) => {\n\t\t\t\tif (defField.model) toexec.populate(field);\n\t\t\t});\n\t\t\tmorePopulate.forEach((field) => {\n\t\t\t\ttoexec.populate(field);\n\t\t\t});\n\t\t\trow = await toexec.exec();\n\t\t}\n\t\treturn row;\n\t}\n\n\t_compareData(oldData, newData) {\n\t\t// console.log(\"oldData, newData\", oldData, newData);\n\t\tvar compare = {};\n\t\tObject.entries(oldData).forEach(([keyoldval, oldval], index) => {\n\t\t\t// console.log(\"keyoldval, typeof ok[keyoldval]\", keyoldval, typeof ok[keyoldval]);\n\t\t\t// if (_.isArray(ok[keyoldval])) return ;\n\t\t\t// if (_.isPlainObject(ok[keyoldval])) return ;\n\t\t\tif (keyoldval == \"updatedAt\") return;\n\t\t\tif (keyoldval == \"createdAt\") return;\n\t\t\tif (newData[keyoldval] == undefined) return;\n\t\t\tvar newval = newData[keyoldval];\n\t\t\t// console.log(\"oldval, newval\", keyoldval, oldval, newval, typeof oldval, typeof newval);\n\t\t\tif (!oldval && !newval) return;\n\t\t\tif (oldval && oldval instanceof Date && !isNaN(oldval.valueOf())) oldval = oldval.toString();\n\t\t\tif (newval && newval instanceof Date && !isNaN(newval.valueOf())) newval = newval.toString();\n\t\t\tif (Array.isArray(oldval)) oldval = JSON.stringify(oldval);\n\t\t\tif (Array.isArray(newval)) newval = JSON.stringify(newval);\n\t\t\tif (this.isObject(oldval)) oldval = JSON.stringify(oldval);\n\t\t\tif (this.isObject(newval)) newval = JSON.stringify(newval);\n\t\t\tif (newval != oldval) {\n\t\t\t\tcompare[keyoldval + \"_old\"] = oldval;\n\t\t\t\tcompare[keyoldval + \"_new\"] = newval;\n\t\t\t}\n\t\t});\n\t\treturn compare;\n\t}\n\tisObject(o) {\n\t\treturn Object.prototype.toString.call(o) === \"[object Object]\";\n\t}\n\n\tasync _create(req) {\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet model = this.model,\n\t\t\tlog = this.modellogevents,\n\t\t\tprimary = this._getPrimary(model),\n\t\t\tnewrow;\n\t\t// console.log(\"req.body\", req.body);\n\n\t\tthis._checkPopulateSended(req);\n\t\t// console.log(\"req.body2 :\", req.body);\n\t\tnewrow = await model.create(req.body).exec(true);\n\t\t// console.log(\"newrow :\", newrow);\n\t\t// console.log(\"newrow\", newrow);\n\t\treq.params.id = newrow[primary];\n\t\tif (log) await this._log(req, \"create\", null, newrow);\n\t\treturn await this._findone(req);\n\t}\n\n\t_checkPopulateSended(req) {\n\t\tlet model = this.model;\n\t\tObject.entries(model.def.attributes).forEach(([field, defField], index) => {\n\t\t\tif (defField.model) {\n\t\t\t\t// console.log(\"defField.model :\", defField.model);\n\t\t\t\tif (req.body[field] && this.isObject(req.body[field])) {\n\t\t\t\t\tlet modelToJoin = global[defField.model];\n\t\t\t\t\tlet primaryToJoin = this._getPrimary(modelToJoin);\n\t\t\t\t\tif (primaryToJoin) req.body[field] = req.body[field][primaryToJoin];\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tasync _update(req, cb) {\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet model = this.model,\n\t\t\tprimary = this._getPrimary(model),\n\t\t\tid = req.params.id || req.params[primary],\n\t\t\twhere = \"\" + primary + \"=?\",\n\t\t\twhereData = [id],\n\t\t\tlog = this.modellogevents,\n\t\t\toldrow,\n\t\t\tnewrow;\n\t\tif (log) {\n\t\t\toldrow = await model.findone(where, whereData).exec();\n\t\t\tif (!oldrow) return null;\n\t\t}\n\t\tdelete req.body[primary];\n\n\t\tthis._checkPopulateSended(req);\n\n\t\tlet row = await model.update(where, whereData, req.body).exec(log);\n\t\tif (!row) return null;\n\t\tif (row.length) newrow = row[0];\n\t\tif (log) await this._log(req, \"update\", oldrow, newrow);\n\n\t\treturn await this._findone(req);\n\t}\n\n\tasync _destroy(req, updateDeleteField = false) {\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet model = this.model,\n\t\t\twhere = \"\",\n\t\t\twhereData = [],\n\t\t\tprimary = this._getPrimary(model),\n\t\t\toldrow,\n\t\t\tlog = this.modellogevents,\n\t\t\tid = req.params.id || req.params[primary];\n\t\twhere = primary + \"=?\";\n\t\twhereData = id;\n\n\t\toldrow = await model.findone(where, whereData).exec();\n\t\tif (!oldrow) return null;\n\t\tif (log) await this._log(req, \"destroy\", oldrow, null);\n\n\t\tif (updateDeleteField === false) {\n\t\t\tawait model.destroy(where, whereData).exec();\n\t\t} else {\n\t\t\tlet d = {};\n\t\t\td[updateDeleteField] = true;\n\t\t\tawait model.update(where, whereData, d).exec();\n\t\t}\n\t\treturn oldrow;\n\t}\n\tasync _log(req, modelEvent, oldrow, newrow) {\n\t\tlet model = this.model,\n\t\t\tprimary = this._getPrimary(model),\n\t\t\tid = req.params.id || req.params[primary];\n\t\tlet c = \"\";\n\t\tif (modelEvent == \"create\") c = newrow;\n\t\telse if (modelEvent == \"destroy\") c = oldrow;\n\t\telse if (modelEvent == \"update\") c = this._compareData(oldrow, newrow);\n\t\tawait Logs.create({\n\t\t\tus_id_user: req.user ? req.user.us_id : 0,\n\t\t\tlg_model_event: modelEvent,\n\t\t\tlg_model_name: this.modelname,\n\t\t\tlg_model_id: id,\n\t\t\tlg_data: c,\n\t\t}).exec();\n\t}\n\n\tasync before(req, res) {}\n\tasync policy(req, res) {\n\t\treturn true;\n\t}\n\t// policies(req, res, next) {\n\t// \tconsole.log(\"iciciicci\");\n\t// \tlet ok = true;\n\t// \tasync.eachSeries(\n\t// \t\treq.policies,\n\t// \t\t(policy, nextPolicy) => {\n\t// \t\t\tif (!Policies[policy]) {\n\t// \t\t\t\tconsole.warn(\"Policy \" + policy + \" not found\");\n\t// \t\t\t\tok = false;\n\t// \t\t\t\treturn nextPolicy();\n\t// \t\t\t}\n\t// \t\t\tPolicies[policy](req, res, ok => {\n\t// \t\t\t\tif (!ok) ok = false;\n\t// \t\t\t\tnextPolicy();\n\t// \t\t\t});\n\t// \t\t},\n\t// \t\t() => {\n\t// \t\t\tnext(ok);\n\t// \t\t}\n\t// \t);\n\t// }\n\trender(page, params) {\n\t\tthis.res.render(page, params);\n\t}\n\t// send(res, data) {\n\t// \tServices.send(res, data);\n\t// }\n};\n"],"file":"BaseController.js"}