{"version":3,"sources":["../src/Controller.js"],"names":["Crud","url","decorator","target","prototype","isCrud","Controller","constructor","populateOnFind","describeRoutes","_routes","forEach","route","console","log","method","toUpperCase","controllerName","name","_addRoutes","App","req","res","next","timer","Date","on","diff","format","_middlewares","middlewareName","mid","Middlewares","find","m","fn","bind","model","sendData","rows","total","_find","data","meta","findone","row","_findone","create","_create","update","_update","destroy","err","Services","oldrow","_destroy","findCreateOrderBy","orderby","query","sort","orderSort","order_sort","replace","findCreateLimit","limit","skip","undefined","findCreateWhere","where","whereData","findCreateWhereForField","tx","field","value","indexOf","push","substring","Object","entries","def","attributes","index","defField","toexec","populate","exec","length","count","createEmpty","_getPrimary","primary","morePopulate","id","params","_compareData","oldData","newData","compare","keyoldval","oldval","newval","isNaN","valueOf","toString","Array","isArray","JSON","stringify","isObject","o","call","_checkPopulateSended","newrow","body","modellogevents","_log","modelToJoin","global","primaryToJoin","updateDeleteField","d","modelEvent","c","Logs","us_id_user","user","us_id","lg_model_event","lg_model_name","modelname","lg_model_id","lg_data","before","policy","render","page","loadControllers","controllerFiles","globule","process","cwd","i","controllerFile","obj","constructorFn"],"mappings":";;;;;;;;;AAAA;;AACA;;AAEA;;AACA;;AAEA;;;;;;;;;;;;AACA;AAEA,SAASA,IAAT,CAAcC,GAAd,EAAmB;AAClB,SAAO,SAASC,SAAT,CAAmBC,MAAnB,EAA2B;AACjC;AACAA,IAAAA,MAAM,CAACC,SAAP,CAAiBC,MAAjB,GAA0BJ,GAA1B;AACA,GAHD;AAIA;;AAED,MAAMK,UAAN,CAAiB;AAChBC,EAAAA,WAAW,GAAG;AACb,SAAKC,cAAL,GAAsB,IAAtB;AACA;;AACDC,EAAAA,cAAc,GAAG;AAChB,SAAKC,OAAL,CAAaC,OAAb,CAAsBC,KAAD,IAAW;AAC/B;AACAC,MAAAA,OAAO,CAACC,GAAR,WAAeF,KAAK,CAACG,MAAN,CAAaC,WAAb,EAAf,cAA6CJ,KAAK,CAACX,GAAnD,gBAA4DW,KAAK,CAACK,cAAlE,gBAAsFL,KAAK,CAACM,IAA5F;AACA,KAHD;AAIA;;AACDC,EAAAA,UAAU,GAAG;AACZ;AACA,SAAKT,OAAL,CAAaC,OAAb,CAAsBC,KAAD,IAAW;AAC/B;AACA;AACAQ,eAAIR,KAAK,CAACG,MAAV,EAAkBH,KAAK,CAACX,GAAxB,EAA6B,CAACoB,GAAD,EAAMC,GAAN,EAAWC,IAAX,KAAoB;AAChD,YAAIC,KAAK,GAAG,IAAIC,IAAJ,EAAZ;AACAJ,QAAAA,GAAG,CAACK,EAAJ,CAAO,KAAP,EAAc,YAAa;AAC1B;AACA,cAAIC,IAAI,GAAG,sBAAQA,IAAR,CAAaH,KAAb,CAAX;AACA,cAAIG,IAAI,GAAG,IAAX,EAAiBA,IAAI,GAAGA,IAAI,GAAG,IAAP,GAAc,GAArB,CAAjB,KACKA,IAAI,IAAI,IAAR,CAJqB,CAK1B;;AACAd,UAAAA,OAAO,CAACC,GAAR,CAAY,sBAAQc,MAAR,CAAe,qBAAf,IAAwC,SAAxC,GAAoDhB,KAAK,CAACX,GAA1D,GAAgE,KAAhE,GAAwE0B,IAApF;AACA,SAPD;AAQAJ,QAAAA,IAAI;AACJ,OAXD;;AAYA,UAAI,KAAKM,YAAT,EAAuB;AACtB,aAAKA,YAAL,CAAkBlB,OAAlB,CAA2BmB,cAAD,IAAoB;AAC7C,cAAIC,GAAG,GAAGC,yBAAYC,IAAZ,CAAkBC,CAAD,IAAO;AACjC,mBAAOA,CAAC,CAAChB,IAAF,IAAUY,cAAjB;AACA,WAFS,CAAV;;AAGA,cAAIC,GAAJ,EAASX,SAAIR,KAAK,CAACG,MAAV,EAAkBH,KAAK,CAACX,GAAxB,EAA6B8B,GAAG,CAACI,EAAJ,CAAOC,IAAP,CAAY,IAAZ,CAA7B;AACT,SALD;AAMA;;AACDhB,eAAIR,KAAK,CAACG,MAAV,EAAkBH,KAAK,CAACX,GAAxB,EAA6BW,KAAK,CAACuB,EAAN,CAASC,IAAT,CAAc,IAAd,CAA7B;AACA,KAxBD;;AAyBA,SAAK3B,cAAL;AACA;;AAEKwB,EAAAA,IAAI,CAACZ,GAAD,EAAMC,GAAN,EAAW;AAAA;;AAAA;AACpB;AACA;AACA,UAAI,CAAC,KAAI,CAACe,KAAV,EAAiB,OAAOf,GAAG,CAACgB,QAAJ,CAAa,mBAAb,CAAP;AACjB,UAAI;AAAEC,QAAAA,IAAF;AAAQC,QAAAA;AAAR,gBAAwB,KAAI,CAACC,KAAL,CAAWpB,GAAX,CAA5B;AACAC,MAAAA,GAAG,CAACgB,QAAJ,CAAa;AAAEI,QAAAA,IAAI,EAAEH,IAAR;AAAcI,QAAAA,IAAI,EAAE;AAAEH,UAAAA,KAAK,EAAEA;AAAT;AAApB,OAAb;AALoB;AAMpB;;AACKI,EAAAA,OAAO,CAACvB,GAAD,EAAMC,GAAN,EAAW;AAAA;;AAAA;AACvB;AACA,UAAI,CAAC,MAAI,CAACe,KAAV,EAAiB,OAAOf,GAAG,CAACgB,QAAJ,CAAahB,GAAb,EAAkB,mBAAlB,CAAP;AACjB,UAAIuB,GAAG,SAAS,MAAI,CAACC,QAAL,CAAczB,GAAd,CAAhB;AACA,UAAI,CAACwB,GAAL,EAAU,OAAOvB,GAAG,CAACgB,QAAJ,CAAa,WAAb,CAAP;AACVhB,MAAAA,GAAG,CAACgB,QAAJ,CAAa;AAAEI,QAAAA,IAAI,EAAEG;AAAR,OAAb;AALuB;AAMvB;;AACKE,EAAAA,MAAM,CAAC1B,GAAD,EAAMC,GAAN,EAAW;AAAA;;AAAA;AACtB;AACA,UAAI,CAAC,MAAI,CAACe,KAAV,EAAiB,OAAOf,GAAG,CAACgB,QAAJ,CAAa,mBAAb,CAAP;AACjB,UAAIO,GAAG,SAAS,MAAI,CAACG,OAAL,CAAa3B,GAAb,CAAhB;AACA,UAAI,CAACwB,GAAL,EAAU,OAAOvB,GAAG,CAACgB,QAAJ,CAAa,cAAb,CAAP;AACVhB,MAAAA,GAAG,CAACgB,QAAJ,CAAa;AAAEI,QAAAA,IAAI,EAAEG;AAAR,OAAb;AALsB;AAMtB;;AACKI,EAAAA,MAAM,CAAC5B,GAAD,EAAMC,GAAN,EAAW;AAAA;;AAAA;AACtB;AACA;AACA,UAAI,CAAC,MAAI,CAACe,KAAV,EAAiB,OAAOf,GAAG,CAACgB,QAAJ,CAAa,mBAAb,CAAP;AACjB,UAAIO,GAAG,SAAS,MAAI,CAACK,OAAL,CAAa7B,GAAb,CAAhB;AACA,UAAI,CAACwB,GAAL,EAAU,OAAOvB,GAAG,CAACgB,QAAJ,CAAa,WAAb,CAAP;AACVhB,MAAAA,GAAG,CAACgB,QAAJ,CAAa;AAAEI,QAAAA,IAAI,EAAEG;AAAR,OAAb;AANsB;AAOtB;;AACKM,EAAAA,OAAO,CAAC9B,GAAD,EAAMC,GAAN,EAAW;AAAA;;AAAA;AACvB;AACA,UAAI,CAAC,MAAI,CAACe,KAAV,EAAiB,OAAOf,GAAG,CAACgB,QAAJ,CAAa;AAAEc,QAAAA,GAAG,EAAEC,mBAASD,GAAT,CAAa,GAAb,CAAP;AAA0BV,QAAAA,IAAI,EAAE;AAAhC,OAAb,CAAP;AACjB,UAAIY,MAAM,SAAS,MAAI,CAACC,QAAL,CAAclC,GAAd,CAAnB;AACAC,MAAAA,GAAG,CAACgB,QAAJ,CAAa;AAAEI,QAAAA,IAAI,EAAEY;AAAR,OAAb;AAJuB;AAKvB;;AAEKE,EAAAA,iBAAiB,CAACnC,GAAD,EAAM;AAAA;AAC5B,UAAIoC,OAAO,GAAG,EAAd,CAD4B,CAE5B;;AACA,UAAIpC,GAAG,CAACqC,KAAJ,CAAUC,IAAd,EAAoB;AACnB,YAAIC,SAAS,GAAG,EAAhB;AACA,YAAIvC,GAAG,CAACqC,KAAJ,CAAUG,UAAd,EAA0BD,SAAS,GAAGvC,GAAG,CAACqC,KAAJ,CAAUG,UAAV,CAAqBC,OAArB,CAA6B,KAA7B,EAAoC,EAApC,CAAZ;AAC1BL,QAAAA,OAAO,GAAG,eAAepC,GAAG,CAACqC,KAAJ,CAAUC,IAAV,CAAeG,OAAf,CAAuB,KAAvB,EAA8B,EAA9B,CAAf,GAAmD,GAAnD,GAAyDF,SAAnE;AACA;;AACD,aAAOH,OAAP;AAR4B;AAS5B;;AACKM,EAAAA,eAAe,CAAC1C,GAAD,EAAM;AAAA;AAC1B,UAAI2C,KAAK,GAAG,EAAZ;AAAA,UACCC,IAAI,GAAG,CADR;;AAEA,UAAI5C,GAAG,CAACqC,KAAJ,CAAUO,IAAV,IAAkBC,SAAlB,IAA+B7C,GAAG,CAACqC,KAAJ,CAAUO,IAAV,IAAkB,KAAjD,IAA0D,QAAQ5C,GAAG,CAACqC,KAAJ,CAAUO,IAAV,GAAiB,CAAzB,MAAgC,QAA9F,EAAwG;AACvGA,QAAAA,IAAI,GAAG5C,GAAG,CAACqC,KAAJ,CAAUO,IAAV,GAAiB,CAAxB;AACA;;AACD,UAAI5C,GAAG,CAACqC,KAAJ,CAAUM,KAAV,IAAmBE,SAAnB,IAAgC,QAAQ7C,GAAG,CAACqC,KAAJ,CAAUM,KAAV,GAAkB,CAA1B,MAAiC,QAArE,EAA+E;AAC9E;AACAA,QAAAA,KAAK,GAAG,YAAYC,IAAZ,GAAmB,GAAnB,GAAyB5C,GAAG,CAACqC,KAAJ,CAAUM,KAAV,GAAkB,CAAnD;AACA;;AACD,aAAOA,KAAP;AAV0B;AAW1B;;AACKG,EAAAA,eAAe,CAAC9C,GAAD,EAAM;AAAA;;AAAA;AAC1B,UAAI+C,KAAK,GAAG,KAAZ;AAAA,UACCC,SAAS,GAAG,EADb;;AAEA,eAASC,uBAAT,CAAiCC,EAAjC,EAAqCC,KAArC,EAA4CC,KAA5C,EAAmD;AAClD;AACA,YAAIA,KAAK,CAACC,OAAN,CAAc,WAAd,MAA+B,CAAnC,EAAsC;AACrCN,UAAAA,KAAK,IAAI,SAASG,EAAT,GAAc,GAAd,GAAoBC,KAApB,GAA4B,SAArC;AACAH,UAAAA,SAAS,CAACM,IAAV,CAAe,MAAMF,KAAK,CAACG,SAAN,CAAgB,CAAhB,CAAN,GAA2B,GAA1C;AACA,SAHD,MAGO,IAAIH,KAAK,CAACC,OAAN,CAAc,YAAd,MAAgC,CAApC,EAAuC;AAC7CN,UAAAA,KAAK,IAAI,SAASG,EAAT,GAAc,GAAd,GAAoBC,KAApB,GAA4B,SAArC;AACAH,UAAAA,SAAS,CAACM,IAAV,CAAeF,KAAK,CAACG,SAAN,CAAgB,EAAhB,IAAsB,GAArC;AACA,SAHM,MAGA,IAAIH,KAAK,CAACC,OAAN,CAAc,UAAd,MAA8B,CAAlC,EAAqC;AAC3CN,UAAAA,KAAK,IAAI,SAASG,EAAT,GAAc,GAAd,GAAoBC,KAApB,GAA4B,SAArC;AACAH,UAAAA,SAAS,CAACM,IAAV,CAAe,MAAMF,KAAK,CAACG,SAAN,CAAgB,CAAhB,CAArB;AACA,SAHM,MAGA,IAAIH,KAAK,CAACC,OAAN,CAAc,IAAd,MAAwB,CAA5B,EAA+B;AACrCN,UAAAA,KAAK,IAAI,SAASG,EAAT,GAAc,GAAd,GAAoBC,KAApB,GAA4B,OAArC;AACAH,UAAAA,SAAS,CAACM,IAAV,CAAeF,KAAK,CAACG,SAAN,CAAgB,CAAhB,CAAf;AACA,SAHM,MAGA,IAAIH,KAAK,CAACC,OAAN,CAAc,GAAd,MAAuB,CAA3B,EAA8B;AACpCN,UAAAA,KAAK,IAAI,SAASG,EAAT,GAAc,GAAd,GAAoBC,KAApB,GAA4B,MAArC;AACAH,UAAAA,SAAS,CAACM,IAAV,CAAeF,KAAK,CAACG,SAAN,CAAgB,CAAhB,CAAf;AACA,SAHM,MAGA,IAAIH,KAAK,CAACC,OAAN,CAAc,IAAd,MAAwB,CAA5B,EAA+B;AACrCN,UAAAA,KAAK,IAAI,SAASG,EAAT,GAAc,GAAd,GAAoBC,KAApB,GAA4B,OAArC;AACAH,UAAAA,SAAS,CAACM,IAAV,CAAeF,KAAK,CAACG,SAAN,CAAgB,CAAhB,CAAf;AACA,SAHM,MAGA,IAAIH,KAAK,CAACC,OAAN,CAAc,GAAd,MAAuB,CAA3B,EAA8B;AACpCN,UAAAA,KAAK,IAAI,SAASG,EAAT,GAAc,GAAd,GAAoBC,KAApB,GAA4B,MAArC;AACAH,UAAAA,SAAS,CAACM,IAAV,CAAeF,KAAK,CAACG,SAAN,CAAgB,CAAhB,CAAf;AACA,SAHM,MAGA;AACNR,UAAAA,KAAK,IAAI,SAASG,EAAT,GAAc,GAAd,GAAoBC,KAApB,GAA4B,IAArC;AACAH,UAAAA,SAAS,CAACM,IAAV,CAAetD,GAAG,CAACqC,KAAJ,CAAUc,KAAV,CAAf;AACA;AACD;;AAEDK,MAAAA,MAAM,CAACC,OAAP,CAAe,MAAI,CAACzC,KAAL,CAAW0C,GAAX,CAAeC,UAA9B,EAA0CrE,OAA1C,CAAkD,OAAoBsE,KAApB,KAA8B;AAAA,YAA7B,CAACT,KAAD,EAAQU,QAAR,CAA6B;AAC/E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,YAAI7D,GAAG,CAACqC,KAAJ,CAAUc,KAAV,CAAJ,EAAsBF,uBAAuB,CAAC,IAAD,EAAOE,KAAP,EAAcnD,GAAG,CAACqC,KAAJ,CAAUc,KAAV,IAAmB,EAAjC,CAAvB;AACtB,YAAInD,GAAG,CAACqC,KAAJ,CAAUc,KAAK,GAAG,GAAlB,CAAJ,EAA4BF,uBAAuB,CAAC,IAAD,EAAOE,KAAP,EAAcnD,GAAG,CAACqC,KAAJ,CAAUc,KAAK,GAAG,GAAlB,CAAd,CAAvB;AAC5B,YAAInD,GAAG,CAACqC,KAAJ,CAAUc,KAAK,GAAG,IAAlB,CAAJ,EAA6BF,uBAAuB,CAAC,IAAD,EAAOE,KAAP,EAAcnD,GAAG,CAACqC,KAAJ,CAAUc,KAAK,GAAG,IAAlB,CAAd,CAAvB;AAC7B,YAAInD,GAAG,CAACqC,KAAJ,CAAUc,KAAK,GAAG,KAAlB,CAAJ,EAA8BF,uBAAuB,CAAC,IAAD,EAAOE,KAAP,EAAcnD,GAAG,CAACqC,KAAJ,CAAUc,KAAK,GAAG,KAAlB,CAAd,CAAvB,CAZiD,CAa/E;AACA,OAdD,EAhC0B,CA+C1B;;AACA,aAAO;AAAEJ,QAAAA,KAAF;AAASC,QAAAA;AAAT,OAAP;AAhD0B;AAiD1B;;AAEK5B,EAAAA,KAAK,CAACpB,GAAD,EAAM;AAAA;;AAAA;AAChB,UAAI;AAAE+C,QAAAA,KAAF;AAASC,QAAAA;AAAT,gBAA6B,MAAI,CAACF,eAAL,CAAqB9C,GAArB,CAAjC,CADgB,CAEhB;;AACA,UAAI2C,KAAK,SAAS,MAAI,CAACD,eAAL,CAAqB1C,GAArB,CAAlB;AACA,UAAIoC,OAAO,SAAS,MAAI,CAACD,iBAAL,CAAuBnC,GAAvB,CAApB;;AACA,UAAI8D,MAAM,GAAG,MAAI,CAAC9C,KAAL,CAAWJ,IAAX,CAAgBmC,KAAK,GAAGX,OAAR,GAAkBO,KAAlC,EAAyCK,SAAzC,CAAb,CALgB,CAMhB;AACA;;;AACA,UAAI,MAAI,CAAC7D,cAAT,EAAyB;AACxBqE,QAAAA,MAAM,CAACC,OAAP,CAAe,MAAI,CAACzC,KAAL,CAAW0C,GAAX,CAAeC,UAA9B,EAA0CrE,OAA1C,CAAkD,QAAoBsE,KAApB,KAA8B;AAAA,cAA7B,CAACT,KAAD,EAAQU,QAAR,CAA6B;AAC/E,cAAIA,QAAQ,CAAC7C,KAAb,EAAoB8C,MAAM,CAACC,QAAP,CAAgBZ,KAAhB;AACpB,SAFD;AAGA,OAZe,CAahB;AACA;AACA;;;AACA,UAAIjC,IAAI,SAAS4C,MAAM,CAACE,IAAP,EAAjB,CAhBgB,CAiBhB;AACA;AACA;;AACA,UAAI7C,KAAK,GAAGD,IAAI,CAAC+C,MAAjB;;AACA,UAAItB,KAAJ,EAAW;AACV;AACA,YAAImB,OAAM,GAAG,MAAI,CAAC9C,KAAL,CAAWkD,KAAX,CAAiBnB,KAAK,GAAGX,OAAzB,EAAkCY,SAAlC,CAAb;;AACA,YAAI,MAAI,CAAC7D,cAAT,EAAyB;AACxBqE,UAAAA,MAAM,CAACC,OAAP,CAAe,MAAI,CAACzC,KAAL,CAAW0C,GAAX,CAAeC,UAA9B,EAA0CrE,OAA1C,CAAkD,QAAoBsE,KAApB,KAA8B;AAAA,gBAA7B,CAACT,KAAD,EAAQU,QAAR,CAA6B;AAC/E,gBAAIA,QAAQ,CAAC7C,KAAb,EAAoB8C,OAAM,CAACC,QAAP,CAAgBZ,KAAhB;AACpB,WAFD;AAGA;;AACDhC,QAAAA,KAAK,SAAS2C,OAAM,CAACE,IAAP,EAAd,CARU,CASV;AACA;AACA,OAhCe,CAiChB;;;AACA,aAAO;AAAE9C,QAAAA,IAAF;AAAQC,QAAAA;AAAR,OAAP;AAlCgB;AAmChB;;AAEKgD,EAAAA,WAAW,CAACnE,GAAD,EAAM;AAAA;;AAAA;AACtB;AACA,UAAIwB,GAAG,GAAG,MAAI,CAACR,KAAL,CAAWmD,WAAX,EAAV;;AACA3C,MAAAA,GAAG,CAAC,MAAI,CAAC4C,WAAL,CAAiB,MAAI,CAACpD,KAAtB,CAAD,CAAH,GAAoC,EAApC;AACA,aAAOQ,GAAP;AAJsB;AAKtB;;AACD4C,EAAAA,WAAW,CAACpD,KAAD,EAAQ;AAClB,QAAIqD,OAAO,GAAG,IAAd;AACAb,IAAAA,MAAM,CAACC,OAAP,CAAezC,KAAK,CAAC0C,GAAN,CAAUC,UAAzB,EAAqCrE,OAArC,CAA6C,QAAoBsE,KAApB,KAA8B;AAAA,UAA7B,CAACT,KAAD,EAAQU,QAAR,CAA6B;AAC1E,UAAIA,QAAQ,CAACQ,OAAb,EAAsBA,OAAO,GAAGlB,KAAV;AACtB,KAFD;AAGA,WAAOkB,OAAP;AACA;;AAEK5C,EAAAA,QAAQ,CAACzB,GAAD,EAAyB;AAAA;AAAA;;AAAA;AAAA,UAAnBsE,YAAmB,0EAAJ,EAAI;;AACtC;AACA,UAAIvB,KAAK,GAAG,EAAZ;AAAA,UACCC,SAAS,GAAG,EADb;AAAA,UAECqB,OAAO,GAAG,MAAI,CAACD,WAAL,CAAiB,MAAI,CAACpD,KAAtB,CAFX;AAAA,UAGCQ,GAHD;AAAA,UAIC+C,EAAE,GAAGvE,GAAG,CAACwE,MAAJ,CAAWD,EAAX,IAAiBvE,GAAG,CAACwE,MAAJ,CAAWH,OAAX,CAJvB;;AAMA,UAAIE,EAAE,GAAG,CAAL,GAAS,CAAb,EAAgB;AACf;AACA/C,QAAAA,GAAG,SAAS,MAAI,CAAC2C,WAAL,CAAiBnE,GAAjB,CAAZ;AACA,OAHD,MAGO;AACN+C,QAAAA,KAAK,IAAI,QAAQsB,OAAR,GAAkB,IAA3B;AACArB,QAAAA,SAAS,CAACM,IAAV,CAAeiB,EAAf;;AACA,YAAIT,MAAM,GAAG,MAAI,CAAC9C,KAAL,CAAWO,OAAX,CAAmBwB,KAAnB,EAA0BC,SAA1B,CAAb;;AACAQ,QAAAA,MAAM,CAACC,OAAP,CAAe,MAAI,CAACzC,KAAL,CAAW0C,GAAX,CAAeC,UAA9B,EAA0CrE,OAA1C,CAAkD,QAAoBsE,KAApB,KAA8B;AAAA,cAA7B,CAACT,KAAD,EAAQU,QAAR,CAA6B;AAC/E,cAAIA,QAAQ,CAAC7C,KAAb,EAAoB8C,MAAM,CAACC,QAAP,CAAgBZ,KAAhB;AACpB,SAFD;AAGAmB,QAAAA,YAAY,CAAChF,OAAb,CAAsB6D,KAAD,IAAW;AAC/BW,UAAAA,MAAM,CAACC,QAAP,CAAgBZ,KAAhB;AACA,SAFD;AAGA3B,QAAAA,GAAG,SAASsC,MAAM,CAACE,IAAP,EAAZ;AACA;;AACD,aAAOxC,GAAP;AAvBsC;AAwBtC;;AAEDiD,EAAAA,YAAY,CAACC,OAAD,EAAUC,OAAV,EAAmB;AAC9B;AACA,QAAIC,OAAO,GAAG,EAAd;AACApB,IAAAA,MAAM,CAACC,OAAP,CAAeiB,OAAf,EAAwBpF,OAAxB,CAAgC,QAAsBsE,KAAtB,KAAgC;AAAA,UAA/B,CAACiB,SAAD,EAAYC,MAAZ,CAA+B;AAC/D;AACA;AACA;AACA,UAAID,SAAS,IAAI,WAAjB,EAA8B;AAC9B,UAAIA,SAAS,IAAI,WAAjB,EAA8B;AAC9B,UAAIF,OAAO,CAACE,SAAD,CAAP,IAAsBhC,SAA1B,EAAqC;AACrC,UAAIkC,MAAM,GAAGJ,OAAO,CAACE,SAAD,CAApB,CAP+D,CAQ/D;;AACA,UAAI,CAACC,MAAD,IAAW,CAACC,MAAhB,EAAwB;AACxB,UAAID,MAAM,IAAIA,MAAM,YAAY1E,IAA5B,IAAoC,CAAC4E,KAAK,CAACF,MAAM,CAACG,OAAP,EAAD,CAA9C,EAAkEH,MAAM,GAAGA,MAAM,CAACI,QAAP,EAAT;AAClE,UAAIH,MAAM,IAAIA,MAAM,YAAY3E,IAA5B,IAAoC,CAAC4E,KAAK,CAACD,MAAM,CAACE,OAAP,EAAD,CAA9C,EAAkEF,MAAM,GAAGA,MAAM,CAACG,QAAP,EAAT;AAClE,UAAIC,KAAK,CAACC,OAAN,CAAcN,MAAd,CAAJ,EAA2BA,MAAM,GAAGO,IAAI,CAACC,SAAL,CAAeR,MAAf,CAAT;AAC3B,UAAIK,KAAK,CAACC,OAAN,CAAcL,MAAd,CAAJ,EAA2BA,MAAM,GAAGM,IAAI,CAACC,SAAL,CAAeP,MAAf,CAAT;AAC3B,UAAI,KAAKQ,QAAL,CAAcT,MAAd,CAAJ,EAA2BA,MAAM,GAAGO,IAAI,CAACC,SAAL,CAAeR,MAAf,CAAT;AAC3B,UAAI,KAAKS,QAAL,CAAcR,MAAd,CAAJ,EAA2BA,MAAM,GAAGM,IAAI,CAACC,SAAL,CAAeP,MAAf,CAAT;;AAC3B,UAAIA,MAAM,IAAID,MAAd,EAAsB;AACrBF,QAAAA,OAAO,CAACC,SAAS,GAAG,MAAb,CAAP,GAA8BC,MAA9B;AACAF,QAAAA,OAAO,CAACC,SAAS,GAAG,MAAb,CAAP,GAA8BE,MAA9B;AACA;AACD,KApBD;AAqBA,WAAOH,OAAP;AACA;;AACDW,EAAAA,QAAQ,CAACC,CAAD,EAAI;AACX,WAAOhC,MAAM,CAACzE,SAAP,CAAiBmG,QAAjB,CAA0BO,IAA1B,CAA+BD,CAA/B,MAAsC,iBAA7C;AACA;;AAEK7D,EAAAA,OAAO,CAAC3B,GAAD,EAAM;AAAA;;AAAA;AAClB;AACA;AACA,UAAIqE,OAAO,GAAG,OAAI,CAACD,WAAL,CAAiB,OAAI,CAACpD,KAAtB,CAAd,CAHkB,CAIlB;;;AAEA,MAAA,OAAI,CAAC0E,oBAAL,CAA0B1F,GAA1B;;AACA,UAAI2F,MAAM,SAAS,OAAI,CAAC3E,KAAL,CAAWU,MAAX,CAAkB1B,GAAG,CAAC4F,IAAtB,EAA4B5B,IAA5B,CAAiC,IAAjC,CAAnB;AACA,UAAI,CAAC2B,MAAL,EAAa,OAAO,IAAP,CARK,CASlB;AACA;AACA;AACA;;AACA3F,MAAAA,GAAG,CAACwE,MAAJ,CAAWD,EAAX,GAAgBoB,MAAM,CAACtB,OAAD,CAAtB;AACA,UAAI,OAAI,CAACwB,cAAT,EAAyB,MAAM,OAAI,CAACC,IAAL,CAAU9F,GAAV,EAAe,QAAf,EAAyB,IAAzB,EAA+B2F,MAA/B,CAAN;AACzB,mBAAa,OAAI,CAAClE,QAAL,CAAczB,GAAd,CAAb;AAfkB;AAgBlB;;AAED0F,EAAAA,oBAAoB,CAAC1F,GAAD,EAAM;AACzBwD,IAAAA,MAAM,CAACC,OAAP,CAAe,KAAKzC,KAAL,CAAW0C,GAAX,CAAeC,UAA9B,EAA0CrE,OAA1C,CAAkD,QAAoBsE,KAApB,KAA8B;AAAA,UAA7B,CAACT,KAAD,EAAQU,QAAR,CAA6B;;AAC/E,UAAIA,QAAQ,CAAC7C,KAAb,EAAoB;AACnB;AACA,YAAIhB,GAAG,CAAC4F,IAAJ,CAASzC,KAAT,KAAmB,KAAKoC,QAAL,CAAcvF,GAAG,CAAC4F,IAAJ,CAASzC,KAAT,CAAd,CAAvB,EAAuD;AACtD,cAAI4C,WAAW,GAAGC,MAAM,CAACnC,QAAQ,CAAC7C,KAAV,CAAxB;;AACA,cAAIiF,aAAa,GAAG,KAAK7B,WAAL,CAAiB2B,WAAjB,CAApB;;AACA,cAAIE,aAAJ,EAAmBjG,GAAG,CAAC4F,IAAJ,CAASzC,KAAT,IAAkBnD,GAAG,CAAC4F,IAAJ,CAASzC,KAAT,EAAgB8C,aAAhB,CAAlB;AACnB;AACD;AACD,KATD;AAUA;;AAEKpE,EAAAA,OAAO,CAAC7B,GAAD,EAAM;AAAA;;AAAA;AAClB;AACA,UAAIqE,OAAO,GAAG,OAAI,CAACD,WAAL,CAAiB,OAAI,CAACpD,KAAtB,CAAd;AAAA,UACCuD,EAAE,GAAGvE,GAAG,CAACwE,MAAJ,CAAWD,EAAX,IAAiBvE,GAAG,CAACwE,MAAJ,CAAWH,OAAX,CADvB;AAAA,UAECtB,KAAK,GAAG,KAAKsB,OAAL,GAAe,IAFxB;AAAA,UAGCrB,SAAS,GAAG,CAACuB,EAAD,CAHb;AAAA,UAICtC,MAJD;AAAA,UAKC0D,MALD,CAFkB,CAQlB;;;AACA,UAAI,OAAI,CAACE,cAAT,EAAyB;AACxB5D,QAAAA,MAAM,SAAS,OAAI,CAACjB,KAAL,CAAWO,OAAX,CAAmBwB,KAAnB,EAA0BC,SAA1B,EAAqCgB,IAArC,EAAf;AACA,YAAI,CAAC/B,MAAL,EAAa,OAAO,IAAP;AACb;;AACD,aAAOjC,GAAG,CAAC4F,IAAJ,CAASvB,OAAT,CAAP;;AAEA,MAAA,OAAI,CAACqB,oBAAL,CAA0B1F,GAA1B;;AACA,UAAIwB,GAAG,SAAS,OAAI,CAACR,KAAL,CAAWY,MAAX,CAAkBmB,KAAlB,EAAyBC,SAAzB,EAAoChD,GAAG,CAAC4F,IAAxC,EAA8C5B,IAA9C,EAAhB;AACA,UAAI,CAACxC,GAAL,EAAU,OAAO,IAAP;AACV,UAAIA,GAAG,CAACyC,MAAR,EAAgB0B,MAAM,GAAGnE,GAAG,CAAC,CAAD,CAAZ;AAChB,UAAI,OAAI,CAACqE,cAAT,EAAyB,MAAM,OAAI,CAACC,IAAL,CAAU9F,GAAV,EAAe,QAAf,EAAyBiC,MAAzB,EAAiC0D,MAAjC,CAAN;AAEzB,mBAAa,OAAI,CAAClE,QAAL,CAAczB,GAAd,CAAb;AArBkB;AAsBlB;;AAEKkC,EAAAA,QAAQ,CAAClC,GAAD,EAAiC;AAAA;AAAA;;AAAA;AAAA,UAA3BkG,iBAA2B,6EAAP,KAAO;;AAC9C;AACA,UAAInD,KAAK,GAAG,EAAZ;AAAA,UACCC,SAAS,GAAG,EADb;AAAA,UAECqB,OAAO,GAAG,OAAI,CAACD,WAAL,CAAiB,OAAI,CAACpD,KAAtB,CAFX;AAAA,UAGCiB,MAHD;AAAA,UAICxC,GAAG,GAAG,OAAI,CAACoG,cAJZ;AAAA,UAKCtB,EAAE,GAAGvE,GAAG,CAACwE,MAAJ,CAAWD,EAAX,IAAiBvE,GAAG,CAACwE,MAAJ,CAAWH,OAAX,CALvB;;AAMAtB,MAAAA,KAAK,GAAGsB,OAAO,GAAG,IAAlB;AACArB,MAAAA,SAAS,GAAGuB,EAAZ;AAEAtC,MAAAA,MAAM,SAAS,OAAI,CAACjB,KAAL,CAAWO,OAAX,CAAmBwB,KAAnB,EAA0BC,SAA1B,EAAqCgB,IAArC,EAAf;AACA,UAAI,CAAC/B,MAAL,EAAa,OAAO,IAAP;AACb,UAAIxC,GAAJ,EAAS,MAAM,OAAI,CAACqG,IAAL,CAAU9F,GAAV,EAAe,SAAf,EAA0BiC,MAA1B,EAAkC,IAAlC,CAAN;;AAET,UAAIiE,iBAAiB,KAAK,KAA1B,EAAiC;AAChC,cAAM,OAAI,CAAClF,KAAL,CAAWc,OAAX,CAAmBiB,KAAnB,EAA0BC,SAA1B,EAAqCgB,IAArC,EAAN;AACA,OAFD,MAEO;AACN,YAAImC,CAAC,GAAG,EAAR;AACAA,QAAAA,CAAC,CAACD,iBAAD,CAAD,GAAuB,IAAvB;AACA,cAAM,OAAI,CAAClF,KAAL,CAAWY,MAAX,CAAkBmB,KAAlB,EAAyBC,SAAzB,EAAoCmD,CAApC,EAAuCnC,IAAvC,EAAN;AACA;;AACD,aAAO/B,MAAP;AAtB8C;AAuB9C;;AACK6D,EAAAA,IAAI,CAAC9F,GAAD,EAAMoG,UAAN,EAAkBnE,MAAlB,EAA0B0D,MAA1B,EAAkC;AAAA;;AAAA;AAC3C,UAAItB,OAAO,GAAG,OAAI,CAACD,WAAL,CAAiB,OAAI,CAACpD,KAAtB,CAAd;AAAA,UACCuD,EAAE,GAAGvE,GAAG,CAACwE,MAAJ,CAAWD,EAAX,IAAiBvE,GAAG,CAACwE,MAAJ,CAAWH,OAAX,CADvB;;AAEA,UAAIgC,CAAC,GAAG,EAAR;AACA,UAAID,UAAU,IAAI,QAAlB,EAA4BC,CAAC,GAAGV,MAAJ,CAA5B,KACK,IAAIS,UAAU,IAAI,SAAlB,EAA6BC,CAAC,GAAGpE,MAAJ,CAA7B,KACA,IAAImE,UAAU,IAAI,QAAlB,EAA4BC,CAAC,GAAG,OAAI,CAAC5B,YAAL,CAAkBxC,MAAlB,EAA0B0D,MAA1B,CAAJ;AACjC,YAAMW,IAAI,CAAC5E,MAAL,CAAY;AACjB6E,QAAAA,UAAU,EAAEvG,GAAG,CAACwG,IAAJ,GAAWxG,GAAG,CAACwG,IAAJ,CAASC,KAApB,GAA4B,CADvB;AAEjBC,QAAAA,cAAc,EAAEN,UAFC;AAGjBO,QAAAA,aAAa,EAAE,OAAI,CAACC,SAHH;AAIjBC,QAAAA,WAAW,EAAEtC,EAJI;AAKjBuC,QAAAA,OAAO,EAAET;AALQ,OAAZ,EAMHrC,IANG,EAAN;AAP2C;AAc3C;;AAEK+C,EAAAA,MAAM,CAAC/G,GAAD,EAAMC,GAAN,EAAW;AAAA;AAAE;;AACnB+G,EAAAA,MAAM,CAAChH,GAAD,EAAMC,GAAN,EAAW;AAAA;AACtB,aAAO,IAAP;AADsB;AAEtB,GAlWe,CAmWhB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACAgH,EAAAA,MAAM,CAACC,IAAD,EAAO1C,MAAP,EAAe;AACpB,SAAKvE,GAAL,CAASgH,MAAT,CAAgBC,IAAhB,EAAsB1C,MAAtB;AACA;;AA1Xe;;;;SA6XF2C,e;;;;;uCAAf,aAAiC;AAChC,QAAIC,eAAe,GAAGC,iBAAQzG,IAAR,CAAa0G,OAAO,CAACC,GAAR,KAAgB,yBAA7B,CAAtB;;AACA,SAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,eAAe,CAACnD,MAApC,EAA4CuD,CAAC,EAA7C,EAAiD;AAChD,UAAMC,cAAc,GAAGL,eAAe,CAACI,CAAD,CAAtC;AACA,UAAIE,GAAG,mCAAgBD,cAAhB,iDAAP;AACAjE,MAAAA,MAAM,CAACC,OAAP,CAAeiE,GAAf,EAAoBpI,OAApB,CAA4B,QAAwBsE,KAAxB,KAAkC;AAAA,YAAjC,CAAC/D,IAAD,EAAO8H,aAAP,CAAiC;AAC7D,YAAItB,CAAC,GAAG,IAAIsB,aAAJ,EAAR;;AACAtB,QAAAA,CAAC,CAACvG,UAAF;AACA,OAHD;AAIA,KAT+B,CAUhC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,G","sourcesContent":["import globule from \"globule\";\nimport dayjs from \"dayjs\";\n\nimport { App } from \"./App\";\nimport { Services } from \"./Services\";\n// import { DbMysql, Model, Models } from \"./DbMysql\";\nimport { Middlewares } from \"./Middlewares\";\n// import { Config } from \"./Config\";\n\nfunction Crud(url) {\n\treturn function decorator(target) {\n\t\t// console.log(\"1\");\n\t\ttarget.prototype.isCrud = url;\n\t};\n}\n\nclass Controller {\n\tconstructor() {\n\t\tthis.populateOnFind = true;\n\t}\n\tdescribeRoutes() {\n\t\tthis._routes.forEach((route) => {\n\t\t\t// eslint-disable-next-line\n\t\t\tconsole.log(`${route.method.toUpperCase()} ${route.url} > ${route.controllerName} > ${route.name}`);\n\t\t});\n\t}\n\t_addRoutes() {\n\t\t// console.log(\"this._routes\", this._routes);\n\t\tthis._routes.forEach((route) => {\n\t\t\t// console.log(\"this\", this, route);\n\t\t\t// console.log(\"this._middlewares\", this._middlewares, Middlewares);\n\t\t\tApp[route.method](route.url, (req, res, next) => {\n\t\t\t\tlet timer = new Date();\n\t\t\t\treq.on(\"end\", (...args) => {\n\t\t\t\t\t// console.log(\"onend args\", args);\n\t\t\t\t\tlet diff = dayjs().diff(timer);\n\t\t\t\t\tif (diff > 1000) diff = diff / 1000 + \"s\";\n\t\t\t\t\telse diff += \"ms\";\n\t\t\t\t\t// eslint-disable-next-line\n\t\t\t\t\tconsole.log(dayjs().format(\"YYYY-MM-DD HH:mm:ss\") + \" - GET \" + route.url + \" - \" + diff);\n\t\t\t\t});\n\t\t\t\tnext();\n\t\t\t});\n\t\t\tif (this._middlewares) {\n\t\t\t\tthis._middlewares.forEach((middlewareName) => {\n\t\t\t\t\tlet mid = Middlewares.find((m) => {\n\t\t\t\t\t\treturn m.name == middlewareName;\n\t\t\t\t\t});\n\t\t\t\t\tif (mid) App[route.method](route.url, mid.fn.bind(this));\n\t\t\t\t});\n\t\t\t}\n\t\t\tApp[route.method](route.url, route.fn.bind(this));\n\t\t});\n\t\tthis.describeRoutes();\n\t}\n\n\tasync find(req, res) {\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\t// console.log(\"find this.model\", this.model);\n\t\tif (!this.model) return res.sendData(\"model_not_defined\");\n\t\tlet { rows, total } = await this._find(req);\n\t\tres.sendData({ data: rows, meta: { total: total } });\n\t}\n\tasync findone(req, res) {\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\tif (!this.model) return res.sendData(res, \"model_not_defined\");\n\t\tlet row = await this._findone(req);\n\t\tif (!row) return res.sendData(\"not_found\");\n\t\tres.sendData({ data: row });\n\t}\n\tasync create(req, res) {\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\tif (!this.model) return res.sendData(\"model_not_defined\");\n\t\tlet row = await this._create(req);\n\t\tif (!row) return res.sendData(\"insert_error\");\n\t\tres.sendData({ data: row });\n\t}\n\tasync update(req, res) {\n\t\t// console.log(\"update\");\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\tif (!this.model) return res.sendData(\"model_not_defined\");\n\t\tlet row = await this._update(req);\n\t\tif (!row) return res.sendData(\"not_found\");\n\t\tres.sendData({ data: row });\n\t}\n\tasync destroy(req, res) {\n\t\t// if (req.dontSanitize !== true) Services.simpleSanitizeReq(req);\n\t\tif (!this.model) return res.sendData({ err: Services.err(501), data: null });\n\t\tlet oldrow = await this._destroy(req);\n\t\tres.sendData({ data: oldrow });\n\t}\n\n\tasync findCreateOrderBy(req) {\n\t\tlet orderby = \"\";\n\t\t// @Marina je corrige ici, car il faut rajouter le orderSort, uniquement s'il y a un req.query.sort\n\t\tif (req.query.sort) {\n\t\t\tlet orderSort = \"\";\n\t\t\tif (req.query.order_sort) orderSort = req.query.order_sort.replace(/\\\\/g, \"\");\n\t\t\torderby = \" order by \" + req.query.sort.replace(/\\\\/g, \"\") + \" \" + orderSort;\n\t\t}\n\t\treturn orderby;\n\t}\n\tasync findCreateLimit(req) {\n\t\tlet limit = \"\",\n\t\t\tskip = 0;\n\t\tif (req.query.skip != undefined && req.query.skip != \"NaN\" && typeof (req.query.skip * 1) === \"number\") {\n\t\t\tskip = req.query.skip * 1;\n\t\t}\n\t\tif (req.query.limit != undefined && typeof (req.query.limit * 1) === \"number\") {\n\t\t\t// if (!req.query.skip || !_.isNumber(req.query.skip * 1)) req.query.skip = 0;\n\t\t\tlimit = \" limit \" + skip + \",\" + req.query.limit * 1;\n\t\t}\n\t\treturn limit;\n\t}\n\tasync findCreateWhere(req) {\n\t\tlet where = \"1=1\",\n\t\t\twhereData = [];\n\t\tfunction findCreateWhereForField(tx, field, value) {\n\t\t\t// console.log(\"field\", field);\n\t\t\tif (value.indexOf(\"contains:\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" like ?\";\n\t\t\t\twhereData.push(\"%\" + value.substring(9) + \"%\");\n\t\t\t} else if (value.indexOf(\"startwith:\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" like ?\";\n\t\t\t\twhereData.push(value.substring(10) + \"%\");\n\t\t\t} else if (value.indexOf(\"endwith:\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" like ?\";\n\t\t\t\twhereData.push(\"%\" + value.substring(8));\n\t\t\t} else if (value.indexOf(\">=\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" >= ?\";\n\t\t\t\twhereData.push(value.substring(2));\n\t\t\t} else if (value.indexOf(\">\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" > ?\";\n\t\t\t\twhereData.push(value.substring(1));\n\t\t\t} else if (value.indexOf(\"<=\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" <= ?\";\n\t\t\t\twhereData.push(value.substring(2));\n\t\t\t} else if (value.indexOf(\"<\") === 0) {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \" < ?\";\n\t\t\t\twhereData.push(value.substring(1));\n\t\t\t} else {\n\t\t\t\twhere += \" && \" + tx + \".\" + field + \"=?\";\n\t\t\t\twhereData.push(req.query[field]);\n\t\t\t}\n\t\t}\n\n\t\tObject.entries(this.model.def.attributes).forEach(([field, defField], index) => {\n\t\t\t// console.log(\"field\", field, req.query[field]);\n\t\t\t// if (defField.model) {\n\t\t\t// \tlet modelJoin = global[defField.model];\n\t\t\t// \t_.each(modelJoin.def.attributes, (defFieldJoin, fieldJoin) => {\n\t\t\t// \t\tif (req.query[fieldJoin]) findCreateWhereForField(\"t1\",fieldJoin, req.query[fieldJoin]);\n\t\t\t// \t\tif (req.query[fieldJoin + \"__\"]) findCreateWhereForField(\"t1\",fieldJoin, req.query[fieldJoin + \"__\"]);\n\t\t\t// \t});\n\t\t\t// } else {\n\t\t\tif (req.query[field]) findCreateWhereForField(\"t1\", field, req.query[field] + \"\");\n\t\t\tif (req.query[field + \"_\"]) findCreateWhereForField(\"t1\", field, req.query[field + \"_\"]);\n\t\t\tif (req.query[field + \"__\"]) findCreateWhereForField(\"t1\", field, req.query[field + \"__\"]);\n\t\t\tif (req.query[field + \"___\"]) findCreateWhereForField(\"t1\", field, req.query[field + \"___\"]);\n\t\t\t// }\n\t\t});\n\t\t// console.log(\"where,whereData\", where, whereData);\n\t\treturn { where, whereData };\n\t}\n\n\tasync _find(req) {\n\t\tlet { where, whereData } = await this.findCreateWhere(req);\n\t\t// console.log(\"where,whereData\", where, whereData);\n\t\tlet limit = await this.findCreateLimit(req);\n\t\tlet orderby = await this.findCreateOrderBy(req);\n\t\tlet toexec = this.model.find(where + orderby + limit, whereData);\n\t\t// console.log(\"where + orderby + limit, whereData\", where + orderby + limit, whereData);\n\t\t// if (this.populateOnFind) {\n\t\tif (this.populateOnFind) {\n\t\t\tObject.entries(this.model.def.attributes).forEach(([field, defField], index) => {\n\t\t\t\tif (defField.model) toexec.populate(field);\n\t\t\t});\n\t\t}\n\t\t// }\n\t\t// let t0;\n\t\t// t0 = moment();\n\t\tlet rows = await toexec.exec();\n\t\t// console.log(\"rows\", rows);\n\t\t// console.log(\"diff1\", t0.diff(moment()));\n\t\t// t0 = moment();\n\t\tlet total = rows.length;\n\t\tif (limit) {\n\t\t\t// console.log(\"where,whereData\", where, whereData);\n\t\t\tlet toexec = this.model.count(where + orderby, whereData);\n\t\t\tif (this.populateOnFind) {\n\t\t\t\tObject.entries(this.model.def.attributes).forEach(([field, defField], index) => {\n\t\t\t\t\tif (defField.model) toexec.populate(field);\n\t\t\t\t});\n\t\t\t}\n\t\t\ttotal = await toexec.exec();\n\t\t\t// console.log(\"rows_temp\", rows_temp);\n\t\t\t// total = rows_temp.length;\n\t\t}\n\t\t// console.log(\"diff2\", t0.diff(moment()));\n\t\treturn { rows, total };\n\t}\n\n\tasync createEmpty(req) {\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet row = this.model.createEmpty();\n\t\trow[this._getPrimary(this.model)] = \"\";\n\t\treturn row;\n\t}\n\t_getPrimary(model) {\n\t\tlet primary = null;\n\t\tObject.entries(model.def.attributes).forEach(([field, defField], index) => {\n\t\t\tif (defField.primary) primary = field;\n\t\t});\n\t\treturn primary;\n\t}\n\n\tasync _findone(req, morePopulate = []) {\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet where = \"\",\n\t\t\twhereData = [],\n\t\t\tprimary = this._getPrimary(this.model),\n\t\t\trow,\n\t\t\tid = req.params.id || req.params[primary];\n\n\t\tif (id * 1 < 0) {\n\t\t\t// console.log(\"createempty\");\n\t\t\trow = await this.createEmpty(req);\n\t\t} else {\n\t\t\twhere += \"t1.\" + primary + \"=?\";\n\t\t\twhereData.push(id);\n\t\t\tlet toexec = this.model.findone(where, whereData);\n\t\t\tObject.entries(this.model.def.attributes).forEach(([field, defField], index) => {\n\t\t\t\tif (defField.model) toexec.populate(field);\n\t\t\t});\n\t\t\tmorePopulate.forEach((field) => {\n\t\t\t\ttoexec.populate(field);\n\t\t\t});\n\t\t\trow = await toexec.exec();\n\t\t}\n\t\treturn row;\n\t}\n\n\t_compareData(oldData, newData) {\n\t\t// console.log(\"oldData, newData\", oldData, newData);\n\t\tvar compare = {};\n\t\tObject.entries(oldData).forEach(([keyoldval, oldval], index) => {\n\t\t\t// console.log(\"keyoldval, typeof ok[keyoldval]\", keyoldval, typeof ok[keyoldval]);\n\t\t\t// if (_.isArray(ok[keyoldval])) return ;\n\t\t\t// if (_.isPlainObject(ok[keyoldval])) return ;\n\t\t\tif (keyoldval == \"updatedAt\") return;\n\t\t\tif (keyoldval == \"createdAt\") return;\n\t\t\tif (newData[keyoldval] == undefined) return;\n\t\t\tvar newval = newData[keyoldval];\n\t\t\t// console.log(\"oldval, newval\", keyoldval, oldval, newval, typeof oldval, typeof newval);\n\t\t\tif (!oldval && !newval) return;\n\t\t\tif (oldval && oldval instanceof Date && !isNaN(oldval.valueOf())) oldval = oldval.toString();\n\t\t\tif (newval && newval instanceof Date && !isNaN(newval.valueOf())) newval = newval.toString();\n\t\t\tif (Array.isArray(oldval)) oldval = JSON.stringify(oldval);\n\t\t\tif (Array.isArray(newval)) newval = JSON.stringify(newval);\n\t\t\tif (this.isObject(oldval)) oldval = JSON.stringify(oldval);\n\t\t\tif (this.isObject(newval)) newval = JSON.stringify(newval);\n\t\t\tif (newval != oldval) {\n\t\t\t\tcompare[keyoldval + \"_old\"] = oldval;\n\t\t\t\tcompare[keyoldval + \"_new\"] = newval;\n\t\t\t}\n\t\t});\n\t\treturn compare;\n\t}\n\tisObject(o) {\n\t\treturn Object.prototype.toString.call(o) === \"[object Object]\";\n\t}\n\n\tasync _create(req) {\n\t\t// console.log(\"req\", req);\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet primary = this._getPrimary(this.model);\n\t\t// console.log(\"req.body\", req.body);\n\n\t\tthis._checkPopulateSended(req);\n\t\tlet newrow = await this.model.create(req.body).exec(true);\n\t\tif (!newrow) return null;\n\t\t// console.log(\"req.body2 :\", req.body, this.model, newrow);\n\t\t// console.log(\"newrow :\", newrow);\n\t\t// console.log(\"newrow\", newrow);\n\t\t// console.log(\"req.params\", req.params, newrow);\n\t\treq.params.id = newrow[primary];\n\t\tif (this.modellogevents) await this._log(req, \"create\", null, newrow);\n\t\treturn await this._findone(req);\n\t}\n\n\t_checkPopulateSended(req) {\n\t\tObject.entries(this.model.def.attributes).forEach(([field, defField], index) => {\n\t\t\tif (defField.model) {\n\t\t\t\t// console.log(\"defField.model :\", defField.model);\n\t\t\t\tif (req.body[field] && this.isObject(req.body[field])) {\n\t\t\t\t\tlet modelToJoin = global[defField.model];\n\t\t\t\t\tlet primaryToJoin = this._getPrimary(modelToJoin);\n\t\t\t\t\tif (primaryToJoin) req.body[field] = req.body[field][primaryToJoin];\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tasync _update(req) {\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet primary = this._getPrimary(this.model),\n\t\t\tid = req.params.id || req.params[primary],\n\t\t\twhere = \"\" + primary + \"=?\",\n\t\t\twhereData = [id],\n\t\t\toldrow,\n\t\t\tnewrow;\n\t\t// console.log(\"log\", log);\n\t\tif (this.modellogevents) {\n\t\t\toldrow = await this.model.findone(where, whereData).exec();\n\t\t\tif (!oldrow) return null;\n\t\t}\n\t\tdelete req.body[primary];\n\n\t\tthis._checkPopulateSended(req);\n\t\tlet row = await this.model.update(where, whereData, req.body).exec();\n\t\tif (!row) return null;\n\t\tif (row.length) newrow = row[0];\n\t\tif (this.modellogevents) await this._log(req, \"update\", oldrow, newrow);\n\n\t\treturn await this._findone(req);\n\t}\n\n\tasync _destroy(req, updateDeleteField = false) {\n\t\t//Services.simpleSanitizeReq(req);\n\t\tlet where = \"\",\n\t\t\twhereData = [],\n\t\t\tprimary = this._getPrimary(this.model),\n\t\t\toldrow,\n\t\t\tlog = this.modellogevents,\n\t\t\tid = req.params.id || req.params[primary];\n\t\twhere = primary + \"=?\";\n\t\twhereData = id;\n\n\t\toldrow = await this.model.findone(where, whereData).exec();\n\t\tif (!oldrow) return null;\n\t\tif (log) await this._log(req, \"destroy\", oldrow, null);\n\n\t\tif (updateDeleteField === false) {\n\t\t\tawait this.model.destroy(where, whereData).exec();\n\t\t} else {\n\t\t\tlet d = {};\n\t\t\td[updateDeleteField] = true;\n\t\t\tawait this.model.update(where, whereData, d).exec();\n\t\t}\n\t\treturn oldrow;\n\t}\n\tasync _log(req, modelEvent, oldrow, newrow) {\n\t\tlet primary = this._getPrimary(this.model),\n\t\t\tid = req.params.id || req.params[primary];\n\t\tlet c = \"\";\n\t\tif (modelEvent == \"create\") c = newrow;\n\t\telse if (modelEvent == \"destroy\") c = oldrow;\n\t\telse if (modelEvent == \"update\") c = this._compareData(oldrow, newrow);\n\t\tawait Logs.create({\n\t\t\tus_id_user: req.user ? req.user.us_id : 0,\n\t\t\tlg_model_event: modelEvent,\n\t\t\tlg_model_name: this.modelname,\n\t\t\tlg_model_id: id,\n\t\t\tlg_data: c,\n\t\t}).exec();\n\t}\n\n\tasync before(req, res) {}\n\tasync policy(req, res) {\n\t\treturn true;\n\t}\n\t// policies(req, res, next) {\n\t// \tconsole.log(\"iciciicci\");\n\t// \tlet ok = true;\n\t// \tasync.eachSeries(\n\t// \t\treq.policies,\n\t// \t\t(policy, nextPolicy) => {\n\t// \t\t\tif (!Policies[policy]) {\n\t// \t\t\t\tconsole.warn(\"Policy \" + policy + \" not found\");\n\t// \t\t\t\tok = false;\n\t// \t\t\t\treturn nextPolicy();\n\t// \t\t\t}\n\t// \t\t\tPolicies[policy](req, res, ok => {\n\t// \t\t\t\tif (!ok) ok = false;\n\t// \t\t\t\tnextPolicy();\n\t// \t\t\t});\n\t// \t\t},\n\t// \t\t() => {\n\t// \t\t\tnext(ok);\n\t// \t\t}\n\t// \t);\n\t// }\n\trender(page, params) {\n\t\tthis.res.render(page, params);\n\t}\n}\n\nasync function loadControllers() {\n\tlet controllerFiles = globule.find(process.cwd() + \"/src/**/*.controller.js\");\n\tfor (let i = 0; i < controllerFiles.length; i++) {\n\t\tconst controllerFile = controllerFiles[i];\n\t\tlet obj = await import(controllerFile);\n\t\tObject.entries(obj).forEach(([name, constructorFn], index) => {\n\t\t\tlet c = new constructorFn();\n\t\t\tc._addRoutes();\n\t\t});\n\t}\n\t// last route is not found\n\t// App.use(async (req, res, next) => {\n\t// \tif (Services.Middlewares.notFound) {\n\t// \t\tawait Services.Middlewares.notFound(req, res, next);\n\t// \t} else {\n\t// \t\tif (req.accepts(\"html\")) return res.status(404).render(\"404\", { Config, cache: Config.app.mode != \"development\" });\n\t// \t\tif (req.accepts(\"json\")) return res.status(404).json({ error: \"Not found\" });\n\t// \t\tres.status(404).type(\"txt\").send(\"Not found\");\n\t// \t}\n\t// });\n}\n\nexport { Controller, Crud, loadControllers };\n"],"file":"Controller.js"}